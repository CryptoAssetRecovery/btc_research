{% extends "base.html" %}

{% block title %}Advanced Charts - Paper Trading{% endblock %}

{% block page_actions %}
    <div style="display: flex; gap: 8px; align-items: center;">
        <!-- Strategy Selection -->
        <div class="dropdown-container">
            <button type="button" class="btn btn-secondary dropdown-btn" onclick="toggleDropdown('strategyDropdown')">
                <span id="selectedStrategyName">Select Strategy</span>
                <span class="dropdown-arrow">▼</span>
            </button>
            <div class="dropdown-menu" id="strategyDropdown">
                {% for strategy in strategies %}
                    <div class="dropdown-item" onclick="selectStrategy('{{ strategy.id }}', '{{ strategy.name or strategy.id[:12] + "..." }}')">
                        <div class="dropdown-item-main">{{ strategy.name or strategy.id[:12] + '...' }}</div>
                        <div class="dropdown-item-sub">{{ strategy.symbol }} - {{ strategy.status|title }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Timeframe Selection -->
        <div class="dropdown-container">
            <button type="button" class="btn btn-secondary dropdown-btn" onclick="toggleDropdown('timeframeDropdown')">
                <span id="selectedTimeframe">1m</span>
                <span class="dropdown-arrow">▼</span>
            </button>
            <div class="dropdown-menu" id="timeframeDropdown">
                <div class="dropdown-item" onclick="changeTimeframe('1m')">1 Minute</div>
                <div class="dropdown-item" onclick="changeTimeframe('5m')">5 Minutes</div>
                <div class="dropdown-item" onclick="changeTimeframe('15m')">15 Minutes</div>
                <div class="dropdown-item" onclick="changeTimeframe('1h')">1 Hour</div>
                <div class="dropdown-item" onclick="changeTimeframe('1d')">1 Day</div>
            </div>
        </div>

        <button onclick="refreshCharts()" class="btn btn-secondary">Refresh</button>
        <button onclick="resetZoom()" class="btn btn-secondary">Reset Zoom</button>
        <button onclick="exportChart()" class="btn btn-primary">Export</button>
    </div>
{% endblock %}

{% block content %}
<style>
    /* Charts-specific minimal design styles */
    .chart-status-bar {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chart-status-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .chart-status-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }
    
    .chart-status-subtitle {
        font-size: 13px;
        color: var(--muted-foreground);
    }
    
    .chart-status-right {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 13px;
    }
    
    .last-update {
        color: var(--muted-foreground);
    }
    
    .connection-info {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .chart-container {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .chart-header {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--secondary);
    }
    
    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }
    
    .chart-controls {
        display: flex;
        gap: 8px;
    }
    
    .chart-control-btn {
        background: none;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 12px;
        color: var(--muted-foreground);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .chart-control-btn:hover {
        background-color: var(--border);
        color: var(--foreground);
    }
    
    .chart-control-btn.active {
        background-color: var(--info);
        color: white;
        border-color: var(--info);
    }
    
    .chart-body {
        padding: 16px;
    }
    
    .chart-canvas-container {
        height: 500px;
        position: relative;
        background-color: var(--background);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .chart-status-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--muted-foreground);
        font-size: 14px;
    }
    
    .performance-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .trade-stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px 16px;
        margin-bottom: 20px;
    }
    
    .dropdown-container {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
        min-width: 120px;
    }
    
    .dropdown-arrow {
        font-size: 10px;
        transition: transform 0.2s ease;
    }
    
    .dropdown-btn.open .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dropdown-menu.show {
        display: block;
    }
    
    .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: background-color 0.2s ease;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background-color: var(--secondary);
    }
    
    .dropdown-item-main {
        font-size: 14px;
        color: var(--foreground);
        font-weight: 500;
    }
    
    .dropdown-item-sub {
        font-size: 12px;
        color: var(--muted-foreground);
        margin-top: 2px;
    }
    
    .volume-profile-container {
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(9, 9, 11, 0.8);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .loading-content {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 32px;
        text-align: center;
        max-width: 300px;
    }
    
    .loading-message {
        font-size: 16px;
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: 8px;
    }
    
    .loading-submessage {
        font-size: 14px;
        color: var(--muted-foreground);
    }
    
    @media (max-width: 768px) {
        .performance-grid {
            grid-template-columns: 1fr;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .trade-stats-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-status-bar {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
        
        .chart-status-right {
            align-self: flex-end;
        }
        
        .chart-canvas-container {
            height: 350px;
        }
    }
    
    /* Connection status animations */
    @keyframes pulse-success {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }
</style>

<!-- Chart Status Bar -->
<div class="chart-status-bar">
    <div class="chart-status-left">
        <h1 class="chart-status-title">Advanced Trading Charts</h1>
        <span id="strategyStatus" class="chart-status-subtitle">
            {% if strategies %}Select a strategy to begin{% else %}No strategies available{% endif %}
        </span>
    </div>
    <div class="chart-status-right">
        <div class="last-update">
            Last Update: <span id="lastUpdate">Never</span>
        </div>
        <div class="connection-info">
            <span class="status-indicator" id="connectionIndicator"></span>
            <span id="connectionStatus">Disconnected</span>
        </div>
    </div>
</div>

<!-- Main Price Chart -->
<div class="chart-container">
    <div class="chart-header">
        <h2 class="chart-title">OHLC Candlestick Chart with Trade Markers</h2>
        <div class="chart-controls">
            <button type="button" class="chart-control-btn" onclick="toggleVolume()" id="volumeToggle">
                Volume
            </button>
            <button type="button" class="chart-control-btn" onclick="toggleIndicators()" id="indicatorsToggle">
                Indicators
            </button>
            <button type="button" class="chart-control-btn" onclick="toggleTradeMarkers()" id="markersToggle">
                Trades
            </button>
        </div>
    </div>
    <div class="chart-body">
        <div class="chart-canvas-container">
            <canvas id="mainChart"></canvas>
        </div>
        <div id="chartStatus">
            <div class="chart-status-message">
                Select a strategy and timeframe to view candlestick chart with trade markers
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts Row -->
<div class="performance-grid">
    <!-- P&L Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <h2 class="chart-title">Performance Analysis</h2>
        </div>
        <div class="chart-body">
            <div style="height: 300px; position: relative; background-color: var(--background); border-radius: 4px; overflow: hidden;">
                <canvas id="performanceChart"></canvas>
            </div>
            <div id="performanceStatus">
                <div class="chart-status-message">
                    Select a strategy to view performance metrics
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trade Statistics -->
    <div class="chart-container">
        <div class="chart-header">
            <h2 class="chart-title">Trade Statistics</h2>
        </div>
        <div class="chart-body">
            <div class="trade-stats-grid">
                <div class="metric-card">
                    <div class="metric-value neutral" id="totalTrades">0</div>
                    <div class="metric-label">Total Trades</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value positive" id="winRate">0%</div>
                    <div class="metric-label">Win Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalPnL">$0.00</div>
                    <div class="metric-label">Total P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral" id="sharpeRatio">0.00</div>
                    <div class="metric-label">Sharpe Ratio</div>
                </div>
            </div>
            
            <!-- Trade Distribution Chart -->
            <div style="height: 120px; position: relative; background-color: var(--background); border-radius: 4px; overflow: hidden;">
                <canvas id="tradeDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Metrics Row -->
<div class="metrics-grid">
    <!-- Volume Profile -->
    <div class="chart-container">
        <div class="chart-header">
            <h2 class="chart-title">Volume Profile Analysis</h2>
        </div>
        <div class="chart-body">
            <div class="volume-profile-container" id="volumeProfileContainer">
                <div class="chart-status-message">
                    Volume profile data will appear here when available
                </div>
            </div>
        </div>
    </div>
    
    <!-- Risk Metrics -->
    <div class="chart-container">
        <div class="chart-header">
            <h2 class="chart-title">Risk Analysis</h2>
        </div>
        <div class="chart-body">
            <div class="trade-stats-grid">
                <div class="metric-card">
                    <div class="metric-value negative" id="maxDrawdown">0%</div>
                    <div class="metric-label">Max Drawdown</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral" id="volatility">0%</div>
                    <div class="metric-label">Volatility</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral" id="avgTrade">$0.00</div>
                    <div class="metric-label">Avg Trade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value neutral" id="profitFactor">0.00</div>
                    <div class="metric-label">Profit Factor</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Trades Table -->
<div class="chart-container">
    <div class="chart-header">
        <h2 class="chart-title">Recent Trades</h2>
        <button class="btn btn-secondary" onclick="exportTrades()">
            Export CSV
        </button>
    </div>
    <div class="chart-body" style="padding: 0;">
        <div style="overflow-x: auto;">
            <table class="table" id="recentTradesTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Size</th>
                        <th>Price</th>
                        <th>P&L</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recentTradesBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px 20px; color: var(--muted-foreground);">
                            No trades to display. Select a strategy to view trade history.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-message">Loading Chart Data...</div>
        <div class="loading-submessage" id="loadingMessage">Fetching market data and trade history...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global chart instances
    let mainTradingChart = null;
    let performanceChart = null;
    let tradeDistributionChart = null;
    
    // Current state
    let currentStrategy = null;
    let currentStrategyName = 'Select Strategy';
    let currentTimeframe = '1m';
    let currentTheme = 'light';
    
    // Chart options
    let chartOptions = {
        showVolume: true,
        showIndicators: true,
        showTradeMarkers: true,
        realTimeUpdates: true
    };

    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        
        // Initialize chart control button states
        document.getElementById('volumeToggle').classList.toggle('active', chartOptions.showVolume);
        document.getElementById('indicatorsToggle').classList.toggle('active', chartOptions.showIndicators);
        document.getElementById('markersToggle').classList.toggle('active', chartOptions.showTradeMarkers);
        
        // Auto-select first strategy if available
        {% if strategies %}
            const firstStrategy = '{{ strategies[0].id }}';
            const firstName = '{{ strategies[0].name or strategies[0].id[:12] + "..." }}';
            setTimeout(() => selectStrategy(firstStrategy, firstName), 1000);
        {% endif %}
        
        // Setup real-time updates
        setupWebSocketUpdates();
        
        // Setup auto-refresh
        setInterval(refreshChartsIfVisible, 30000); // Every 30 seconds
    });

    function initializeCharts() {
        // Initialize main trading chart
        mainTradingChart = new AdvancedTradingChart('mainChart', {
            theme: currentTheme,
            showVolume: chartOptions.showVolume,
            showTradeMarkers: chartOptions.showTradeMarkers,
            showIndicators: chartOptions.showIndicators,
            realTimeUpdates: chartOptions.realTimeUpdates
        });

        // Initialize performance chart
        performanceChart = new PerformanceChart('performanceChart', {
            showDrawdown: true,
            showBenchmark: false
        });

        // Initialize trade distribution chart
        initializeTradeDistributionChart();
    }

    function initializeTradeDistributionChart() {
        const ctx = document.getElementById('tradeDistributionChart').getContext('2d');
        tradeDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Winning Trades', 'Losing Trades'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#22c55e', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    async function selectStrategy(strategyId, strategyName) {
        if (!strategyId) return;
        
        currentStrategy = strategyId;
        currentStrategyName = strategyName;
        
        // Update UI
        document.getElementById('selectedStrategyName').textContent = strategyName;
        document.getElementById('strategyStatus').textContent = `Loading data for ${strategyName}...`;
        
        await loadStrategyData();
    }

    async function loadStrategyData() {
        if (!currentStrategy) return;
        
        showLoading(true, 'Loading comprehensive chart data...');
        
        try {
            // Fetch all required data in parallel
            const [chartResponse, statsResponse, tradesResponse] = await Promise.all([
                fetch(`/api/chart-data/${currentStrategy}?period=${currentTimeframe}`),
                apiClient.getStrategyStats(currentStrategy),
                apiClient.getStrategyTrades(currentStrategy, 50, 0)
            ]);
            
            const chartData = await chartResponse.json();
            
            if (chartData.error) {
                throw new Error(chartData.error);
            }
            
            // Update main trading chart
            const indicators = await fetchIndicators(currentStrategy);
            mainTradingChart.updateData(
                chartData.market_data || [],
                chartData.trades || [],
                indicators
            );
            
            // Update performance chart
            const performanceData = await fetchPerformanceData(currentStrategy);
            performanceChart.updateData(performanceData);
            
            // Update statistics
            updateStatistics(statsResponse, chartData.trades || []);
            
            // Update recent trades table
            updateRecentTradesTable(chartData.trades || []);
            
            // Update status
            document.getElementById('strategyStatus').textContent = `${currentStrategyName} - ${currentTimeframe}`;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('chartStatus').innerHTML = `
                <div class="chart-status-message" style="color: var(--success);">
                    Chart loaded: ${chartData.market_data?.length || 0} candles, ${chartData.trades?.length || 0} trades
                </div>
            `;
            
            updateConnectionStatus('connected');
            
        } catch (error) {
            console.error('Error loading strategy data:', error);
            
            document.getElementById('chartStatus').innerHTML = `
                <div class="chart-status-message" style="color: var(--danger);">
                    Error loading chart data: ${error.message}
                </div>
            `;
            
            updateConnectionStatus('error');
            showToast('Failed to load chart data: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function showLoading(show, message = 'Loading chart data...') {
        const overlay = document.getElementById('loadingOverlay');
        const messageEl = document.getElementById('loadingMessage');
        
        if (show) {
            if (messageEl) messageEl.textContent = message;
            overlay.style.display = 'flex';
        } else {
            overlay.style.display = 'none';
        }
    }

    async function fetchIndicators(strategyId) {
        try {
            // Fetch indicator data from API
            const response = await fetch(`/api/v1/statistics/strategies/${strategyId}/indicators`);
            if (response.ok) {
                return await response.json();
            }
        } catch (error) {
            console.warn('Indicators not available:', error);
        }
        return {};
    }

    async function fetchPerformanceData(strategyId) {
        try {
            const response = await apiClient.get(`/api/v1/statistics/strategies/${strategyId}/performance`);
            return response.data || [];
        } catch (error) {
            console.warn('Performance data not available:', error);
            return [];
        }
    }

    function updateStatistics(statsResponse, trades) {
        const stats = statsResponse?.data || {};
        const performance = stats.performance || {};
        const trading = stats.trading || {};
        
        // Update trade statistics
        document.getElementById('totalTrades').textContent = performance.total_trades || 0;
        document.getElementById('winRate').textContent = formatPercentage(performance.win_rate || 0);
        document.getElementById('totalPnL').textContent = formatCurrency(performance.total_return || 0);
        document.getElementById('sharpeRatio').textContent = (performance.sharpe_ratio || 0).toFixed(2);
        
        // Update risk metrics
        document.getElementById('maxDrawdown').textContent = formatPercentage(performance.max_drawdown || 0);
        document.getElementById('volatility').textContent = formatPercentage(performance.volatility || 0);
        document.getElementById('avgTrade').textContent = formatCurrency(performance.avg_trade || 0);
        document.getElementById('profitFactor').textContent = (performance.profit_factor || 0).toFixed(2);
        
        // Update P&L color
        const totalPnL = performance.total_return || 0;
        const pnlElement = document.getElementById('totalPnL');
        pnlElement.className = `metric-value ${totalPnL >= 0 ? 'text-success' : 'text-danger'}`;
        
        // Update trade distribution chart
        const winningTrades = trades.filter(t => (t.pnl || 0) > 0).length;
        const losingTrades = trades.filter(t => (t.pnl || 0) < 0).length;
        
        tradeDistributionChart.data.datasets[0].data = [winningTrades, losingTrades];
        tradeDistributionChart.update();
    }

    function updateRecentTradesTable(trades) {
        const tbody = document.getElementById('recentTradesBody');
        
        if (!trades || trades.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px 20px; color: var(--muted-foreground);">
                        No trades available for this strategy
                    </td>
                </tr>
            `;
            return;
        }
        
        // Sort trades by timestamp (newest first)
        const sortedTrades = trades.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        tbody.innerHTML = sortedTrades.slice(0, 10).map(trade => {
            const pnl = parseFloat(trade.pnl || 0);
            const pnlColor = pnl > 0 ? 'var(--success)' : pnl < 0 ? 'var(--danger)' : 'var(--muted-foreground)';
            const sideColor = trade.side.toLowerCase() === 'buy' ? 'var(--success)' : 'var(--danger)';
            const sideIcon = trade.side.toLowerCase() === 'buy' ? '↑' : '↓';
            
            return `
                <tr>
                    <td style="font-size: 13px; color: var(--muted-foreground); font-variant-numeric: tabular-nums;">${formatDateTime(trade.timestamp)}</td>
                    <td style="font-weight: 600;">${trade.symbol || 'BTC/USDT'}</td>
                    <td>
                        <span style="color: ${sideColor}; display: flex; align-items: center; gap: 4px;">
                            <span>${sideIcon}</span>
                            ${trade.side.toUpperCase()}
                        </span>
                    </td>
                    <td style="font-variant-numeric: tabular-nums;">${parseFloat(trade.size || 0).toFixed(4)}</td>
                    <td style="font-variant-numeric: tabular-nums;">${formatCurrency(trade.price)}</td>
                    <td style="color: ${pnlColor}; font-variant-numeric: tabular-nums;">
                        ${pnl !== 0 ? (pnl > 0 ? '+' : '') + formatCurrency(pnl) : '-'}
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="highlightTradeOnChart('${trade.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function changeTimeframe(timeframe) {
        currentTimeframe = timeframe;
        document.getElementById('selectedTimeframe').textContent = timeframe;
        
        if (currentStrategy) {
            loadStrategyData();
        }
    }


    function toggleVolume() {
        chartOptions.showVolume = !chartOptions.showVolume;
        const btn = document.getElementById('volumeToggle');
        btn.classList.toggle('active', chartOptions.showVolume);
        
        if (mainTradingChart) {
            mainTradingChart.options.showVolume = chartOptions.showVolume;
            if (currentStrategy) loadStrategyData();
        }
    }

    function toggleIndicators() {
        chartOptions.showIndicators = !chartOptions.showIndicators;
        const btn = document.getElementById('indicatorsToggle');
        btn.classList.toggle('active', chartOptions.showIndicators);
        
        if (mainTradingChart) {
            mainTradingChart.options.showIndicators = chartOptions.showIndicators;
            if (currentStrategy) loadStrategyData();
        }
    }

    function toggleTradeMarkers() {
        chartOptions.showTradeMarkers = !chartOptions.showTradeMarkers;
        const btn = document.getElementById('markersToggle');
        btn.classList.toggle('active', chartOptions.showTradeMarkers);
        
        if (mainTradingChart) {
            mainTradingChart.options.showTradeMarkers = chartOptions.showTradeMarkers;
            if (currentStrategy) loadStrategyData();
        }
    }

    // Dropdown functionality
    function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const btn = dropdown.previousElementSibling;
        
        // Close all other dropdowns
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            if (menu.id !== dropdownId) {
                menu.classList.remove('show');
                menu.previousElementSibling.classList.remove('open');
            }
        });
        
        // Toggle current dropdown
        dropdown.classList.toggle('show');
        btn.classList.toggle('open');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
                menu.previousElementSibling.classList.remove('open');
            });
        }
    });

    function refreshCharts() {
        if (currentStrategy) {
            loadStrategyData();
        }
    }

    function refreshChartsIfVisible() {
        // Only refresh if page is visible and not loading
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (!document.hidden && loadingOverlay.style.display === 'none' && currentStrategy) {
            loadStrategyData();
        }
    }

    function resetZoom() {
        if (mainTradingChart) {
            mainTradingChart.resetZoom();
        }
    }

    function exportChart() {
        if (mainTradingChart) {
            const filename = `${currentStrategyName}-${currentTimeframe}-${new Date().toISOString().split('T')[0]}.png`;
            mainTradingChart.exportChart(filename);
            showToast('Chart exported successfully!', 'success');
        }
    }

    function exportTrades() {
        if (!currentStrategy) {
            showToast('Please select a strategy first', 'warning');
            return;
        }
        
        // Get recent trades data and convert to CSV
        const rows = Array.from(document.querySelectorAll('#recentTradesTable tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 6) return null;
            
            return [
                cells[0].textContent.trim(),
                cells[1].textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim()
            ].join(',');
        }).filter(row => row !== null);
        
        if (rows.length === 0) {
            showToast('No trades to export', 'warning');
            return;
        }
        
        const csv = ['Time,Symbol,Side,Size,Price,P&L', ...rows].join('\n');
        const filename = `${currentStrategyName}-trades-${new Date().toISOString().split('T')[0]}.csv`;
        
        downloadFile(filename, csv, 'text/csv');
        showToast('Trades exported successfully!', 'success');
    }

    function highlightTradeOnChart(tradeId) {
        showToast('Trade highlighted on chart', 'info');
        // TODO: Implement trade highlighting on chart
    }

    function updateConnectionStatus(status) {
        const indicator = document.getElementById('connectionIndicator');
        const statusText = document.getElementById('connectionStatus');
        
        switch (status) {
            case 'connected':
                indicator.className = 'status-indicator';
                indicator.style.backgroundColor = 'var(--success)';
                indicator.style.animation = 'pulse-success 2s infinite';
                statusText.textContent = 'Connected';
                statusText.style.color = 'var(--success)';
                break;
            case 'disconnected':
                indicator.className = 'status-indicator';
                indicator.style.backgroundColor = 'var(--danger)';
                indicator.style.animation = 'none';
                statusText.textContent = 'Disconnected';
                statusText.style.color = 'var(--danger)';
                break;
            case 'error':
                indicator.className = 'status-indicator';
                indicator.style.backgroundColor = 'var(--warning)';
                indicator.style.animation = 'none';
                statusText.textContent = 'Error';
                statusText.style.color = 'var(--warning)';
                break;
        }
    }

    function setupWebSocketUpdates() {
        if (typeof socket !== 'undefined') {
            socket.on('strategy_update', function(data) {
                if (data.strategy_id === currentStrategy) {
                    console.log('Charts: Real-time update received');
                    // Refresh charts with new data after a short delay
                    setTimeout(() => {
                        if (currentStrategy === data.strategy_id) {
                            loadStrategyData();
                        }
                    }, 2000);
                }
            });
            
            socket.on('connect', function() {
                updateConnectionStatus('connected');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus('disconnected');
            });
        }
    }

    // Page visibility handling
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentStrategy) {
            // Page became visible, refresh data
            setTimeout(() => loadStrategyData(), 1000);
        }
    });
</script>
{% endblock %}